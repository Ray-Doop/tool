# @generated-file-note
# 文件：smart-tools-backend/smart-tools-api/src/main/resources/application.yml
# 用途：Spring Boot 默认配置（开发默认 H2 + JWT/CORS/限流等）
# 归属：后端 smart-tools-api
# 分层：resources
# 顶层键：server、spring、file、app、wxlogin、logging
# 环境变量：SERVER_PORT、MAIL_HOST、MAIL_PORT、MAIL_USERNAME、MAIL_PASSWORD、MAIL_SMTP_CONNECTION_TIMEOUT、MAIL_SMTP_TIMEOUT、MAIL_SMTP_WRITE_TIMEOUT、MAIL_SMTP_SSL_ENABLE、MAIL_SMTP_SSL_PROTOCOLS、MAIL_SMTP_STARTTLS_ENABLE、MAIL_SMTP_STARTTLS_REQUIRED、MAIL_SMTP_LOCALHOST、MAIL_DEBUG、MAIL_FROM、user.dir、JWT_SECRET、CORS_ALLOWED_ORIGINS
# 约束：敏感配置仅允许通过环境变量注入，禁止写死到仓库
# 维护：新增配置项时保持与 README 的环境变量说明同步
server:
  port: ${SERVER_PORT:9090}
  # 优雅停机：配合容器/网关在发布时平滑下线
  shutdown: graceful
  tomcat:
    threads:
      # Tomcat 工作线程：并发请求的主要处理线程
      max: 200
      min-spare: 20
    # accept-count：当工作线程占满时，允许排队等待的连接数
    accept-count: 200
    # 连接超时：防止慢连接占用资源
    connection-timeout: 20s

spring:
  autoconfigure:
    exclude: org.springframework.boot.autoconfigure.security.servlet.UserDetailsServiceAutoConfiguration
  mail:
    host: ${MAIL_HOST:smtp.qq.com}
    port: ${MAIL_PORT:587}
    username: ${MAIL_USERNAME:}
    password: ${MAIL_PASSWORD:}
    properties:
      mail:
        smtp:
          auth: true
          connectiontimeout: ${MAIL_SMTP_CONNECTION_TIMEOUT:10000}
          timeout: ${MAIL_SMTP_TIMEOUT:10000}
          writetimeout: ${MAIL_SMTP_WRITE_TIMEOUT:10000}
          ssl:
            enable: ${MAIL_SMTP_SSL_ENABLE:false}
            protocols: ${MAIL_SMTP_SSL_PROTOCOLS:TLSv1.2}
          starttls:
            enable: ${MAIL_SMTP_STARTTLS_ENABLE:true}
            required: ${MAIL_SMTP_STARTTLS_REQUIRED:true}
          localhost: ${MAIL_SMTP_LOCALHOST:}
        debug: ${MAIL_DEBUG:false}
  mail-from: ${MAIL_FROM:${MAIL_USERNAME:}}
  datasource:
    url: jdbc:h2:mem:smart_tools;MODE=MySQL;DB_CLOSE_DELAY=-1;DATABASE_TO_UPPER=false
    username: sa
    password:
    hikari:
      # 数据库连接池：高并发下限制最大连接数，防止把 DB 打挂
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      max-lifetime: 1800000
  jpa:
    hibernate:
      ddl-auto: none
    open-in-view: false
    properties:
      hibernate:
        format_sql: true
  h2:
    console:
      enabled: true
      path: /h2-console
  sql:
    init:
      mode: always
      schema-locations: classpath:schema.sql

file:
  upload-dir: ${user.dir}/uploads

app:
  thread-pool:
    # 应用异步线程池参数（用于 @Async 写日志等）
    core-size: 8
    max-size: 64
    queue-capacity: 2000
    keep-alive-seconds: 60
  jwt:
    # JWT 密钥建议通过环境变量 JWT_SECRET 注入（至少 32 字符）
    secret: ${JWT_SECRET:change-me-change-me-change-me-change-me}
    issuer: smart-tools
    expiration-seconds: 604800
    access-expiration-seconds: 900
    refresh-expiration-seconds: 604800
    refresh-cookie-name: smart_tools_refresh
    refresh-cookie-path: /api/auth
    refresh-cookie-same-site: Strict
    refresh-cookie-secure: false
  cors:
    # 允许跨域的前端域名（支持逗号分隔）
    allowed-origins: ${CORS_ALLOWED_ORIGINS:http://localhost:5173}
  otp:
    ttl-seconds: ${OTP_TTL_SECONDS:60}
    log-code: ${OTP_LOG_CODE:false}
  risk:
    enabled: ${RISK_ENABLED:true}
    global-requests-per-minute: ${GLOBAL_REQUESTS_PER_MINUTE:600}
    device-requests-per-minute: ${DEVICE_REQUESTS_PER_MINUTE:300}
    auth-requests-per-minute: ${AUTH_REQUESTS_PER_MINUTE:120}
    window-cache-max-entries: ${WINDOW_CACHE_MAX_ENTRIES:200000}
    window-cleanup-every-requests: ${WINDOW_CLEANUP_EVERY_REQUESTS:2000}
    otp-send-cooldown-seconds: ${OTP_SEND_COOLDOWN_SECONDS:60}
wxlogin:
  app-id: ${WXLOGIN_APP_ID:}
  app-secret: ${WXLOGIN_APP_SECRET:}

logging:
  level:
    org.hibernate.SQL: INFO
    org.hibernate.orm.jdbc.bind: INFO
